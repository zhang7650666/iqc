<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Page title -->
    <title>质检</title>

    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <!--<link rel="shortcut icon" type="image/ico" href="favicon.ico" />-->

    <!-- Vendor styles -->
    <link rel="stylesheet" href="vendor/fontawesome/css/font-awesome.css" />
    <link rel="stylesheet" href="vendor/metisMenu/dist/metisMenu.css" />
    <link rel="stylesheet" href="vendor/animate.css/animate.css" />
    <link rel="stylesheet" href="vendor/bootstrap/dist/css/bootstrap.css" />
    <link rel="stylesheet" href="vendor/sweetalert/lib/sweet-alert.css" />
    <link rel="stylesheet" href="vendor/toastr/build/toastr.min.css" />
    <!-- <link
      rel="stylesheet"
      href="vendor/datatables.net-bs/css/dataTables.bootstrap.min.css"
    /> -->

    <link
      rel="stylesheet"
      href="vendor/bootstrap-datepicker-master/dist/css/bootstrap-datepicker3.min.css"
    />
    <link
      rel="stylesheet"
      href="vendor/awesome-bootstrap-checkbox/awesome-bootstrap-checkbox.css"
    />
    <link
      rel="stylesheet"
      href="vendor/clockpicker/dist/bootstrap-clockpicker.min.css"
    />
    <link
      rel="stylesheet"
      href="vendor/eonasdan-bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.min.css"
    />

    <!-- App styles -->
    <link
      rel="stylesheet"
      href="fonts/pe-icon-7-stroke/css/pe-icon-7-stroke.css"
    />
    <link rel="stylesheet" href="fonts/pe-icon-7-stroke/css/helper.css" />
    <link rel="stylesheet" href="styles/style.css" />
    <link rel="stylesheet" href="styles/flex.css" />
  </head>
  <body class="fixed-navbar fixed-sidebar">
    <!--[if lt IE 7]>
      <p class="alert alert-danger">
        You are using an <strong>outdated</strong> browser. Please
        <a href="http://browsehappy.com/">upgrade your browser</a> to improve
        your experience.
      </p>
    <![endif]-->

    <!-- Header -->
    <div id="header" class="clear">
      <div class="color-line"></div>
      <!-- 常屏 项目名 -->
      <div id="logo" class="light-version">
        <span> 材料检验客户端 </span>
      </div>

      <!--  小屏 顶部导航 -->
      <nav role="navigation">
        <div class="header-link hide-menu"><i class="fa fa-bars"></i></div>
        <div class="small-logo">
          <span class="text-primary">材料检验客户端</span>
        </div>
        <div class="mobile-menu">
          <button
            type="button"
            class="navbar-toggle mobile-menu-toggle"
            data-toggle="collapse"
            data-target="#mobile-collapse"
          >
            <i class="fa fa-chevron-down"></i>
          </button>
          <div class="collapse mobile-navbar" id="mobile-collapse">
            <ul class="nav navbar-nav">
              <li>
                <a type="button" class="btn btn-text logoutBtn">Logout</a>
              </li>
            </ul>
          </div>
        </div>
        <!-- 常屏 顶部导航 -->
        <div class="navbar-right">
          <ul class="nav navbar-nav no-borders">
            <li class="dropdown">
              <a type="button" class="btn btn-text logoutBtn">
                <i class="pe-7s-upload pe-rotate-90"></i>
              </a>
            </li>
          </ul>
        </div>
      </nav>
    </div>

    <!-- Navigation -->
    <aside id="menu">
      <div id="navigation">
        <ul class="nav" id="side-menu">
            <li class="active">
              <a href="index-y.html">
                <span class="nav-label">首页</span>
                <!-- <span class="label label-success pull-right">v.1</span> -->
              </a>
            </li>
            <li>
              <a href="create_form-z.html">
                <span class="nav-label">新建表单</span>
                <!-- <span class="label label-warning pull-right">NEW</span> -->
              </a>
            </li>
        </ul>
      </div>
    </aside>

    <!-- Main Wrapper -->
    <div id="wrapper">
      <div class="content animate-panel">
        <div class="hpanel">
          <div class="panel-body">
            <!-- <h2 class="font-light m-b-xs">Colors and Buttons</h2> -->
            <!-- <small>The basic color palette</small> -->
            <ul id="unit-info-box" class="l-s-n line34"></ul>
          </div>
        </div>

        <!-- 见证记录 -->
        <div class="hpanel print-wp">
          <div class="panel-body">
            <div class="p-m">
              <button
                id="createContract"
                type="button"
                class="btn btn-primary print-hide pull-right"
              >
                新建
              </button>
            </div>
            <div class="pr-wp por txt-center p-b-lg">
              <h3 class="pr-name txt-center" id="project-title">
                工程名称：工程名称工程名称工程名称工程名称工程名称
              </h3>
            </div>
            <!-- 筛选 -->
            <form class="form-inline print-hide">
              <div class="form-group m-b">
                <label>日期：</label>
                <input
                  id="WHC_PayDate"
                  name="start"
                  type="text"
                  placeholder="选择开始日期"
                  data-date-format="yyyy-mm"
                  class="form-control"
                  
                />
              </div>
              <div class="form-group p-l-md">
                <label for="class">分类选择：</label>
                <select class="form-control" name="account" id="class">
                  <option value="">不限</option>
                  <option value="0" selected="true">未见证</option>
                  <option value="1">已见证</option>
                </select>
              </div>
              <div class="form-group p-l-md">
                <label for="status">报告类型：</label>
                <select class="form-control" name="account" id="status">
                  <option value="" selected="true">全部</option>
                  <option value="0">未见证</option>
                  <option value="1">已见证</option>
                </select>
              </div>
              <div class="form-group p-l-md fillter-btn" style="margin-top: 15px;" >
                <button type="button" class="btn btn-info" id="filterTableBtn">
                  筛选
                </button>
              </div>
              <div class="form-group p-l-md" style="margin-top: 15px;">
                <button type="button" class="btn btn-info print">
                  打印列表
                </button>
              </div>
            </form>
            <br />
            <div class="table-responsive">
              <table
                cellpadding="1"
                cellspacing="1"
                class="table table-bordered table-striped"
                id="print"
              >
                <thead>
                  <tr>
                    <th>日期</th>
                    <th>试件编号</th>
                    <th>试件名称</th>
                    <th>委托人</th>
                    <th>见证人</th>
                    <th>检验机构</th>
                    <th>检测表单</th>
                    <th>状态</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="tableBody"></tbody>
                <tfoot id="tableFoot" class="hidden">
                  <tr>
                    <td colspan="6">
                      <nav aria-label="Page navigation">
                        <ul
                          class="pagination pull-right"
                          id="paginationBox"
                        ></ul>
                      </nav>
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>
      


    </div>
    <!-- Vendor scripts -->
    <script src="vendor/jquery/dist/jquery.min.js"></script>
    <script src="vendor/jquery-ui/jquery-ui.min.js"></script>
    <script src="vendor/slimScroll/jquery.slimscroll.min.js"></script>
    <script src="vendor/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="vendor/jquery-flot/jquery.flot.js"></script>
    <script src="vendor/jquery-flot/jquery.flot.resize.js"></script>
    <script src="vendor/jquery-flot/jquery.flot.pie.js"></script>
    <script src="vendor/flot.curvedlines/curvedLines.js"></script>
    <script src="vendor/jquery.flot.spline/index.js"></script>
    <script src="vendor/metisMenu/dist/metisMenu.min.js"></script>
    <script src="vendor/iCheck/icheck.min.js"></script>
    <script src="vendor/peity/jquery.peity.min.js"></script>
    <script src="vendor/sparkline/index.js"></script>
    <script src="vendor/sweetalert/lib/sweet-alert.min.js"></script>
    <script src="vendor/toastr/build/toastr.min.js"></script>
    <script src="vendor/moment/moment.js"></script>
    <script src="vendor/bootstrap-datepicker-master/dist/js/bootstrap-datepicker.min.js"></script>
    <script src="vendor/clockpicker/dist/bootstrap-clockpicker.min.js"></script>
    <script src="vendor/eonasdan-bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script>
    <!-- App scripts -->
    <script src="scripts/jquery.jqprint-0.3.js"></script>
    <script src="scripts/homer.js"></script>
    <script>
      // 解决打印报错
      jQuery.browser = {};
      (function () {
        jQuery.browser.msie = false;
        jQuery.browser.version = 0;
        if (navigator.userAgent.match(/MSIE ([0-9]+)./)) {
          jQuery.browser.msie = true;
          jQuery.browser.version = RegExp.$1;
        }
      })();
      // 日期控件中文
      ;(function($){
        $.fn.datepicker.dates['zh-CN'] = {
          days: ["星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六"],
          daysShort: ["周日", "周一", "周二", "周三", "周四", "周五", "周六"],
          daysMin: ["日", "一", "二", "三", "四", "五", "六"],
          months: ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"],
          monthsShort: ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"],
          today: "今天",
          monthsTitle: "选择月份",
          clear: "清除",
          format: "yyyy-mm-dd",
          titleFormat: "yyyy年mm月",
          weekStart: 1
        };
      }(jQuery));
    </script>
    <script>
      
      var queryObj = query2obj(window.location.href);
      // 获取分类数据
      $.get("http://meterial.cxhy.cn/getClassifyList/", function (res) {
        var classList = res.data;
      })
      // var userInfo = getUserInfo();
      var sevenAgo = moment().subtract(7, "days").format("YYYY-MM");
      $("#WHC_PayDate").datepicker("setDate", sevenAgo);

      getUnitDetail();
      getList();

      // var today = ymd();
      
      //初始化日期
      $("#WHC_PayDate")
        .datepicker({
          format: 'yyyy-mm',    
          language: "zh-CN", //语言
          autoclose: true, //选择后自动关闭
          todayHighlight: true, //今天日期高亮
          startView: 'months',
          maxViewMode:'years',
          minViewMode:'months'
        })
        
      
      

      $("#createContract").click(function () {
        window.location.href = "./create_form-z.html";
      });
      //生成分页元素
      function getPaginatLi(pagesCount) {
        if (pagesCount == 0 || pagesCount == "" || pagesCount === undefined) {
          return "";
        }
        var num = "";
        for (var i = 1; i < pagesCount; i++) {
          num +=
            '<li><a href="#" data-page="' + pagesCount + '">' + i + "</a></li>";
        }

        var paginationEle = [
          '<li><a href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span> </a>',
          num,
          '<li><a href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span> </a></li>',
        ];

        $("#paginationBox").html(paginationEle.join(""));
        $("#tableFoot").removeClass("hidden");
      }

      // 创建表格
      function createTr(data) {
        if (!Array.isArray(data)) {
          // console.error("数据异常");
          return "";
        }

        var trs = [];
        // 没有数据时，插入空数据占位
        !data.length &&
          trs.push(
            '<tr class="txt-center"><td colspan="9">--没有数据--</td></tr>'
          );

        var target_month = $("#WHC_PayDate").val(); // 开始日期
        $(data).each(function (idx, item) {
          var isWitness = item.status == 1;
          var readDetail =
            " <a href='tables_design-z.html?id=" +
            item.id +
            "&target_month=" +
            target_month +
            "&type=contract'> " +
            "合同详情</a>";
          var witnessDetail =
            " <a href='tables_design-z.html?id=" +
            item.id +
            "&target_month=" +
            target_month +
            "&type=witness'> " +
            "见证详情</a>";

          var cancleDetail =
            '<button type="button" class="btn btn-info cancleWitness" data-id="' +
            item.id +
            '">取消见证</button>';

          trs.push(
            "<tr> " +
              [
                "<td> " + item.update_at + "</td> ",
                "<td> 试件编号</td>",
                "<td> 试件名称</td>",
                "<td> 委托人</td>",
                "<td> 见证人</td>",
                "<td> 检验机构</td>",
                "<td> 检测表单</td>",
                "<td> " + (isWitness ? "已见证" : "非见证") + "</td>",
                "<td class='td-set'>" +
                  readDetail +
                  (isWitness ? witnessDetail : "") +
                  (item.witness_record_id == 1 ? cancleDetail : "") +
                  "</td>",
              ].join("") +
              "</tr> "
          );
        });

        $("#tableBody").html(trs.join(""));

        // $(".cancleWitness").on("click", function () {
        //   var id = $(this).attr("data-id");
        //   // cancelWitness/
        //   $.ajax({
        //     url: "http://meterial.cxhy.cn/cancelWitness/",
        //     type: "POST",
        //     dataType: "json",
        //     contentType: "application/json",
        //     data: JSON.stringify({
        //       id: id,
        //       target_month: $("#WHC_PayDate").val(),
        //     }),
        //     success: function (res) {
        //       if (res.code == 200) {
        //         toastr && toastr.success("取消见证记录成功！");
        //         getList();
        //       }
        //     },
        //     error: function (error) {},
        //   });
        // });
      }

      //获取表格数据
      function getList() {
        var status = $("#status").val() || 0;
        console.log('target_month', $("#WHC_PayDate").val())
        $.get(
          "http://meterial.cxhy.cn/getRecordList/",
          {
            status: status,
            target_month: $("#WHC_PayDate").val(), // 开始日期
            classifyId: '', // to do
          },
          function (res) {
            var data = res.data;
            var total = data.total || 0;
            var pagesCount = parseInt(total) / 20;
            getPaginatLi(pagesCount);
            createTr(data);
          }
        );
      }

      $("document").on("click", "cancleWitness", function () {
        var id = $(this).attr("data-id");
        // cancelWitness/
        $.ajax({
          url: "http://meterial.cxhy.cn/cancelWitness/",
          type: "POST",
          dataType: "json",
          contentType: "application/json",
          data: JSON.stringify({
            id: id,
            target_month: $("#WHC_PayDate").val(), // 开始日期
          }),
          success: function (res) {
            if (res.code == 200) {
              toastr && toastr.success("取消见证记录成功！");
              getList();
            }
          },
          error: function (error) {},
        });
      });

      $("#filterTableBtn").on("click", function () {
        getList();
      });

      // 点击打印
      $(".print").click(function () {
        $(".print-hide").hide();
        $(".print-wp").jqprint();
        $(".print-hide").show();
      });
    </script>
  </body>
</html>
