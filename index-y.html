<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Page title -->
    <title>质检</title>

    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <!--<link rel="shortcut icon" type="image/ico" href="favicon.ico" />-->

    <!-- Vendor styles -->
    <link rel="stylesheet" href="vendor/fontawesome/css/font-awesome.css" />
    <link rel="stylesheet" href="vendor/metisMenu/dist/metisMenu.css" />
    <link rel="stylesheet" href="vendor/animate.css/animate.css" />
    <link rel="stylesheet" href="vendor/bootstrap/dist/css/bootstrap.css" />
    <link rel="stylesheet" href="vendor/sweetalert/lib/sweet-alert.css" />
    <link rel="stylesheet" href="vendor/toastr/build/toastr.min.css" />
    <!-- <link
      rel="stylesheet"
      href="vendor/datatables.net-bs/css/dataTables.bootstrap.min.css"
    /> -->

    <link
      rel="stylesheet"
      href="vendor/bootstrap-datepicker-master/dist/css/bootstrap-datepicker3.min.css"
    />
    <link
      rel="stylesheet"
      href="vendor/awesome-bootstrap-checkbox/awesome-bootstrap-checkbox.css"
    />
    <link
      rel="stylesheet"
      href="vendor/clockpicker/dist/bootstrap-clockpicker.min.css"
    />
    <link
      rel="stylesheet"
      href="vendor/eonasdan-bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.min.css"
    />

    <!-- App styles -->
    <link
      rel="stylesheet"
      href="fonts/pe-icon-7-stroke/css/pe-icon-7-stroke.css"
    />
    <link rel="stylesheet" href="fonts/pe-icon-7-stroke/css/helper.css" />
    <link rel="stylesheet" href="styles/style.css" />
    <link rel="stylesheet" href="styles/flex.css" />
  </head>
  <body class="fixed-navbar fixed-sidebar">
    <!--[if lt IE 7]>
      <p class="alert alert-danger">
        You are using an <strong>outdated</strong> browser. Please
        <a href="http://browsehappy.com/">upgrade your browser</a> to improve
        your experience.
      </p>
    <![endif]-->

    <!-- Header -->
    <div id="header">
      <div class="color-line"></div>
      <!-- 常屏 项目名 -->
      <div id="logo" class="light-version">
        <span> 材料检验客户端 </span>
      </div>

      <!--  小屏 顶部导航 -->
      <nav role="navigation">
        <div class="header-link hide-menu"><i class="fa fa-bars"></i></div>
        <div class="small-logo">
          <span class="text-primary">材料检验客户端</span>
        </div>
        <div class="mobile-menu">
          <button
            type="button"
            class="navbar-toggle mobile-menu-toggle"
            data-toggle="collapse"
            data-target="#mobile-collapse"
          >
            <i class="fa fa-chevron-down"></i>
          </button>
          <div class="collapse mobile-navbar" id="mobile-collapse">
            <ul class="nav navbar-nav">
              <!-- <li>
                <a class="" href="login.html">Login</a>
              </li> -->
              <li>
                <a type="button" class="btn btn-text logoutBtn">Logout</a>
              </li>
            </ul>
          </div>
        </div>
        <!-- 常屏 顶部导航 -->
        <div class="navbar-right">
          <ul class="nav navbar-nav no-borders">
            <li class="dropdown">
              <a type="button" class="btn btn-text logoutBtn">
                <i class="pe-7s-upload pe-rotate-90"></i>
              </a>
            </li>
          </ul>
        </div>
      </nav>
    </div>

    <!-- Navigation -->
    <aside id="menu">
      <div id="navigation">
        <ul class="nav" id="side-menu"></ul>
      </div>
    </aside>

    <!-- Main Wrapper -->
    <div id="wrapper">
      <div class="content animate-panel">
        <!-- 新建分类见证表 -->
        <div class="hpanel">
          <div class="panel-body">
            <a href="#" class="btn btn-link">新建</a>
          </div>
        </div>

        <!-- 见证记录 -->
        <div class="hpanel">
          <div class="panel-body">
            <form class="form-inline">
              <div class="form-group">
                <label for="target_day">日期：</label>
                <input
                  id="target_day"
                  type="text"
                  value=""
                  class="form-control"
                />
              </div>
              <div class="form-group p-l-md">
                <label for="status">状态：</label>
                <select class="form-control" name="account" id="status">
                  <option value="">不限</option>
                  <option value="0" selected="true">未见证</option>
                  <option value="1">已见证</option>
                </select>
              </div>
              <div class="form-group p-l-md">
                <button
                  type="button"
                  class="btn btn-primary"
                  id="filterTableBtn"
                >
                  筛选
                </button>
              </div>
            </form>
            <br />
            <div class="table-responsive">
              <table
                cellpadding="1"
                cellspacing="1"
                class="table table-bordered table-striped"
              >
                <thead>
                  <tr>
                    <th>ID</th>
                    <th width="200px">日期</th>
                    <th>项目编号</th>
                    <th>状态</th>
                    <!-- <th>见证记录</th> -->
                    <th>备注</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="tableBody"></tbody>
                <tfoot id="tableFoot" class="hidden">
                  <tr>
                    <td colspan="6">
                      <nav aria-label="Page navigation">
                        <ul
                          class="pagination pull-right"
                          id="paginationBox"
                        ></ul>
                      </nav>
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Vendor scripts -->
    <script src="vendor/jquery/dist/jquery.min.js"></script>
    <script src="vendor/jquery-ui/jquery-ui.min.js"></script>
    <script src="vendor/slimScroll/jquery.slimscroll.min.js"></script>
    <script src="vendor/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="vendor/jquery-flot/jquery.flot.js"></script>
    <script src="vendor/jquery-flot/jquery.flot.resize.js"></script>
    <script src="vendor/jquery-flot/jquery.flot.pie.js"></script>
    <script src="vendor/flot.curvedlines/curvedLines.js"></script>
    <script src="vendor/jquery.flot.spline/index.js"></script>
    <script src="vendor/metisMenu/dist/metisMenu.min.js"></script>
    <script src="vendor/iCheck/icheck.min.js"></script>
    <script src="vendor/peity/jquery.peity.min.js"></script>
    <script src="vendor/sparkline/index.js"></script>
    <script src="vendor/sweetalert/lib/sweet-alert.min.js"></script>
    <script src="vendor/toastr/build/toastr.min.js"></script>
    <script src="vendor/moment/moment.js"></script>
    <script src="vendor/bootstrap-datepicker-master/dist/js/bootstrap-datepicker.min.js"></script>
    <script src="vendor/clockpicker/dist/bootstrap-clockpicker.min.js"></script>
    <script src="vendor/eonasdan-bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script>
    <!-- App scripts -->
    <script src="scripts/homer.js"></script>

    <script>
      //生成左侧列表
      createList && createList();
      //初始化日期
      $("#target_day").datepicker({
        language: "zh-CN",
        autoclose: true, //选中之后自动隐藏日期选择框
        // clearBtn: true, //清除按钮
        todayBtn: true, //今日按钮
        todayHighlight: true,
        format: "yyyy-mm-dd",
        // viewDate: ymd(),
      });
      $("#target_day").val(ymd());
      //生成分页元素
      function getPaginatLi(pagesCount) {
        if (pagesCount == 0 || pagesCount == "" || pagesCount === undefined) {
          return "";
        }
        var num = "";
        for (var i = 1; i < pagesCount; i++) {
          num +=
            '<li><a href="#" data-page="' + pagesCount + '">' + i + "</a></li>";
        }

        var paginationEle = [
          '<li><a href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span> </a>',
          num,
          '<li><a href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span> </a></li>',
        ];

        $("#paginationBox").html(paginationEle.join(""));
        $("#tableFoot").removeClass("hidden");
      }

      function createTr(data) {
        if (!Array.isArray(data)) {
          // console.error("数据异常");
          return "";
        }

        var trs = "";
        var target_day = $("#target_day").val();
        $(data).each(function (idx, item) {
          var readDetail =
            " <a href='tables_design-z.html?id=" +
            item.id +
            "&target_day=" +
            target_day +
            "'> " +
            "合同详情</a>";

          var witnessDetail =
            " <a href='tables_design-z.html?id=" +
            item.id +
            "&target_day=" +
            target_day +
            "'> " +
            "见证详情</a>";

          var cancleDetail =
            '<button type="button" class="btn btn-info cancleWitness" data-id="' +
            item.id +
            '">取消见证</button>';

          trs +=
            "<tr> <td> " +
            item.id +
            "</td> <td> " +
            item.update_at +
            "</td><td> " +
            item.project_id +
            "</td><td> " +
            (item.status == 1 ? "已见证" : "非见证") +
            "</td><td>-</td><td class='td-set'>" +
            readDetail +
            witnessDetail +
            (item.witness_record_id == 1 ? cancleDetail : "") +
            "</td>" +
            "</tr>";
        });

        $("#tableBody").html(trs);

        $(".cancleWitness").on("click", function () {
          var id = $(this).attr("data-id");
          // cancelWitness/
          $.ajax({
            url: "http://meterial.cxhy.cn/cancelWitness/",
            type: "POST",
            dataType: "json",
            contentType: "application/json",
            data: JSON.stringify({
              id: id,
              target_day: target_day,
            }),
            success: function (res) {
              if (res.code == 200) {
                toastr && toastr.success("取消见证记录成功！");
                localStorage.setItem("iqc_user_info", "");
                getList();
              }
            },
            error: function (error) {},
          });
        });
      }

      //获取表格数据
      function getList() {
        var status = $("#status").val() || 0;
        var target_day = $("#target_day").val();
        // target_day = target_day.split("-").reverse().join("-");
        $.get(
          "http://meterial.cxhy.cn/getRecordList/",
          {
            status: status,
            target_day: target_day,
          },
          function (res) {
            var data = res.data;
            var total = data.total || 0;
            var pagesCount = parseInt(total) / 20;
            getPaginatLi(pagesCount);
            createTr(data);
          }
        );
      }

      getList();

      $("#filterTableBtn").on("click", function () {
        getList();
      });
    </script>
  </body>
</html>
