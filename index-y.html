<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Page title -->
    <title>质检</title>

    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <!--<link rel="shortcut icon" type="image/ico" href="favicon.ico" />-->

    <!-- Vendor styles -->
    <link rel="stylesheet" href="vendor/fontawesome/css/font-awesome.css" />
    <link rel="stylesheet" href="vendor/metisMenu/dist/metisMenu.css" />
    <link rel="stylesheet" href="vendor/animate.css/animate.css" />
    <link rel="stylesheet" href="vendor/bootstrap/dist/css/bootstrap.css" />
    <link rel="stylesheet" href="vendor/sweetalert/lib/sweet-alert.css" />
    <link rel="stylesheet" href="vendor/toastr/build/toastr.min.css" />
    <!-- <link
      rel="stylesheet"
      href="vendor/datatables.net-bs/css/dataTables.bootstrap.min.css"
    /> -->

    <link
      rel="stylesheet"
      href="vendor/bootstrap-datepicker-master/dist/css/bootstrap-datepicker3.min.css"
    />
    <link
      rel="stylesheet"
      href="vendor/awesome-bootstrap-checkbox/awesome-bootstrap-checkbox.css"
    />
    <link
      rel="stylesheet"
      href="vendor/clockpicker/dist/bootstrap-clockpicker.min.css"
    />
    <link
      rel="stylesheet"
      href="vendor/eonasdan-bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.min.css"
    />

    <!-- App styles -->
    <link
      rel="stylesheet"
      href="fonts/pe-icon-7-stroke/css/pe-icon-7-stroke.css"
    />
    <link rel="stylesheet" href="fonts/pe-icon-7-stroke/css/helper.css" />
    <link rel="stylesheet" href="styles/style.css" />
    <link rel="stylesheet" href="styles/flex.css" />
  </head>
  <body class="fixed-navbar fixed-sidebar">
    <!--[if lt IE 7]>
      <p class="alert alert-danger">
        You are using an <strong>outdated</strong> browser. Please
        <a href="http://browsehappy.com/">upgrade your browser</a> to improve
        your experience.
      </p>
    <![endif]-->

    <!-- Header -->
    <div id="header" class="clear">
      <div class="color-line"></div>
      <!-- 常屏 项目名 -->
      <div id="logo" class="light-version">
        <span> 材料检验客户端 </span>
      </div>

      <!--  小屏 顶部导航 -->
      <nav role="navigation">
        <div class="header-link hide-menu"><i class="fa fa-bars"></i></div>
        <div class="small-logo">
          <span class="text-primary">材料检验客户端</span>
        </div>
        <div class="mobile-menu">
          <button
            type="button"
            class="navbar-toggle mobile-menu-toggle"
            data-toggle="collapse"
            data-target="#mobile-collapse"
          >
            <i class="fa fa-chevron-down"></i>
          </button>
          <div class="collapse mobile-navbar" id="mobile-collapse">
            <ul class="nav navbar-nav">
              <li>
                <a type="button" class="btn btn-text logoutBtn">Logout</a>
              </li>
            </ul>
          </div>
        </div>
        <!-- 面包线 -->
        <div id="hbreadcrumb">
          <ol class="hbreadcrumb breadcrumb">
            <li class="active">
              <span>首页</span>
            </li>
          </ol>
        </div>

        <!-- 常屏 顶部导航 -->
        <div class="navbar-right">
          <ul class="nav navbar-nav no-borders">
            <li class="word-no-wp" data-toggle="modal" data-target="#myModal7">
              <span>工程编号：</span>
              <span class="word-no"></span>
            </li>
            <li class="dropdown">
              <a type="button" class="btn btn-text logoutBtn">
                <i class="pe-7s-upload pe-rotate-90"></i>
              </a>
            </li>
          </ul>
        </div>
      </nav>
    </div>
    <!-- 工程信息摸态框 -->
    <div
      class="modal fade hmodal-success"
      id="myModal7"
      tabindex="-1"
      role="dialog"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content" >
          <div class="color-line"></div>
          <div class="modal-header" style="padding: 15px">
            <h4 class="modal-title">我的工程信息</h4>
          </div>
          <div class="modal-body">
            <div class="hpanel">
              <div class="panel-body">
                <form
                  action="#"
                  id="p-e-form"
                  class="form-horizontal label-right"
                >
                </form>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">
              关闭
            </button>
            <button type="button" class="btn btn-primary">保存</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Navigation -->
    <aside id="menu" class="home-menu">
      <div id="navigation">
        <ul class="nav" id="side-menu">
          <li class="active">
            <a href="index-y.html" class="hight">
              <span class="nav-label">
                <i class="pe-7s-home nav-icon"></i> 首页</span
              >
            </a>
          </li>
          <li>
            <a href="create_form-z.html">
              <span class="nav-label"
                ><i class="pe-7s-news-paper nav-icon"></i> 新建表单</span
              >
              <!-- <span class="label label-warning pull-right">NEW</span> -->
            </a>
          </li>
        </ul>
      </div>
    </aside>

    <!-- Main Wrapper -->
    <div id="wrapper">
      <div class="content animate-panel">
        <div class="hpanel">
          <div class="panel-body">
            <!-- <h2 class="font-light m-b-xs">Colors and Buttons</h2> -->
            <!-- <small>The basic color palette</small> -->
            <ul id="unit-info-box" class="l-s-n line34"></ul>
          </div>
        </div>

        <!-- 见证记录 -->
        <div class="hpanel print-wp">
          <div class="panel-body">
            <div
              class="p-m"
              style="position: absolute; top: 0px; right: 0px; z-index: 99"
            >
              <button
                id="createContract"
                type="button"
                class="btn btn-primary print-hide pull-right"
              >
                新建
              </button>
            </div>
            <div class="pr-wp por txt-center p-b-lg">
              <h3 class="pr-name txt-center" id="project-title">
                工程名称：工程名称工程名称工程名称工程名称工程名称
              </h3>
            </div>
            <!-- 筛选 -->
            <form class="form-inline print-hide">
              <div class="form-group" style="margin-bottom: 15px !important">
                <label>日期：</label>
                <input
                  id="WHC_PayDate"
                  type="text"
                  placeholder="选择开始日期"
                  data-date-format="yyyy-mm"
                  class="form-control"
                />
              </div>
              <div
                class="form-group p-l-md"
                style="margin-bottom: 15px !important"
              >
                <label for="classify">分类选择：</label>
                <select class="form-control" name="account" id="classify">
                  <option value="">不限</option>
                  <option value="0" selected="true">未见证</option>
                  <option value="1">已见证</option>
                </select>
              </div>
              <div
                class="form-group p-l-md"
                style="margin-bottom: 15px !important"
              >
                <label for="status">报告类型：</label>
                <select class="form-control" name="account" id="status">
                  <option value="" selected="true">全部</option>
                  <option value="0">未见证</option>
                  <option value="1">已见证</option>
                </select>
              </div>
              <div
                class="form-group p-l-md fillter-btn"
                style="margin-bottom: 15px !important"
              >
                <button type="button" class="btn btn-info" id="filterTableBtn">
                  筛选
                </button>
              </div>
              <div
                class="form-group p-l-md"
                style="margin-bottom: 15px !important"
              >
                <button type="button" class="btn btn-info print">
                  打印列表
                </button>
              </div>
            </form>
            <br />
            <div class="table-responsive">
              <table
                cellpadding="1"
                cellspacing="1"
                class="table table-bordered table-striped"
                id="print"
              >
                <thead>
                  <tr>
                    <th>日期</th>
                    <th>试件编号</th>
                    <th>试件名称</th>
                    <th>委托人</th>
                    <th>见证人</th>
                    <th>检验机构</th>
                    <th>状态</th>
                    <th>检测表单</th>
                    <th>见证报告</th>
                  </tr>
                </thead>
                <tbody id="tableBody"></tbody>
              </table>
            </div>
            <tfoot id="tableFoot" class="hidden">
              <tr>
                <td colspan="6">
                  <nav
                    aria-label="Page navigation"
                    style="position: relative; padding-bottom: 15px"
                  >
                    <div
                      class="total"
                      style="position: absolute; left: 0px; top: 5px"
                    >
                      总共 <span style="color: #3498db"></span> 数据
                    </div>
                    <ul
                      class="pagination pull-right"
                      id="paginationBox"
                      style="margin: 0px"
                    ></ul>
                  </nav>
                </td>
              </tr>
            </tfoot>
          </div>
        </div>
      </div>
    </div>
    <!-- Vendor scripts -->
    <script src="vendor/jquery/dist/jquery.min.js"></script>
    <script src="vendor/jquery-ui/jquery-ui.min.js"></script>
    <script src="vendor/slimScroll/jquery.slimscroll.min.js"></script>
    <script src="vendor/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="vendor/jquery-flot/jquery.flot.js"></script>
    <script src="vendor/jquery-flot/jquery.flot.resize.js"></script>
    <script src="vendor/jquery-flot/jquery.flot.pie.js"></script>
    <script src="vendor/flot.curvedlines/curvedLines.js"></script>
    <script src="vendor/jquery.flot.spline/index.js"></script>
    <script src="vendor/metisMenu/dist/metisMenu.min.js"></script>
    <script src="vendor/iCheck/icheck.min.js"></script>
    <script src="vendor/peity/jquery.peity.min.js"></script>
    <script src="vendor/sparkline/index.js"></script>
    <script src="vendor/sweetalert/lib/sweet-alert.min.js"></script>
    <script src="vendor/toastr/build/toastr.min.js"></script>
    <script src="vendor/moment/moment.js"></script>
    <script src="vendor/bootstrap-datepicker-master/dist/js/bootstrap-datepicker.min.js"></script>
    <script src="vendor/clockpicker/dist/bootstrap-clockpicker.min.js"></script>
    <script src="vendor/eonasdan-bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script>
    <script src="vendor/datatables/media/js/jquery.dataTables.min.js"></script>
    <script src="vendor/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <!-- App scripts -->
    <script src="scripts/jquery.jqprint-0.3.js"></script>
    <script src="scripts/homer.js"></script>
    <script src="scripts/zh.js"></script>
    <script>
      // 解决打印报错
      jQuery.browser = {};
      (function () {
        jQuery.browser.msie = false;
        jQuery.browser.version = 0;
        if (navigator.userAgent.match(/MSIE ([0-9]+)./)) {
          jQuery.browser.msie = true;
          jQuery.browser.version = RegExp.$1;
        }
      })();
    </script>
    <script>
      var opt_classify_id = ""; //分类id
      var pageIndex = 1;
      var queryObj = query2obj(window.location.href);
      // 获取分类数据
      $.get("http://meterial.cxhy.cn/getClassifyList/", function (res) {
        if (res.code == 200) {
          // 默认传第一个分类id
          opt_classify_id = "";
          // 获取表格数据
          getList();
          res.data.unshift({ classify_name: "全部", id: "" });
          createOptions("classify", res.data);
        }
      });
      function createOptions(idEle, optList) {
        var optStr = "";
        optList.forEach(function (item) {
          optStr +=
            '<option value="' +
            item.id +
            '">' +
            item.classify_name +
            "</option>";
        });
        $("#" + idEle).html(optStr);
      }
      // 下拉选择选中事件

      $("#classify").change(function () {
        opt_classify_id = $(this).val();
      });
      getUnitDetail();
      // var userInfo = getUserInfo();
      // 设置默认时间
      var sevenAgo = moment().subtract(7, "days").format("YYYY-MM");

      //初始化日期
      $("#WHC_PayDate").datepicker({
        language: "zh-CN", //语言
        autoclose: true, //选择后自动关闭
        // todayHighlight: true, //今天日期高亮
        startView: "months",
        maxViewMode: "years",
        minViewMode: "months",
        minView: 3,
      });
      $("#WHC_PayDate").val(sevenAgo);

      $("#createContract").click(function () {
        window.location.href = "./create_form-z.html";
      });
      //生成分页元素
      function getPaginatLi(pagesCount) {
        console.log(666, pagesCount);
        if (
          pagesCount == 0 ||
          pagesCount == 1 ||
          pagesCount == "" ||
          pagesCount === undefined
        ) {
          return "";
        }
        var num = "";
        for (var i = 1; i <= pagesCount; i++) {
          num +=
            '<li class="' +
            (i == 1 ? "active" : "") +
            ' page"><a href="javascript:;" data-page="' +
            pagesCount +
            '">' +
            i +
            "</a></li>";
        }

        var paginationEle = [
          '<li class="page-pre"><a href="javascript:;" aria-label="Previous"><span aria-hidden="true">&laquo;</span> </a>',
          num,
          '<li class="page-next"><a href="javascript:;" aria-label="Next"><span aria-hidden="true">&raquo;</span> </a></li>',
        ];

        $("#paginationBox").html(paginationEle.join(""));
        $("#tableFoot").removeClass("hidden");
        // 切换
        $("#paginationBox .page").click(function () {
          $(this).siblings().removeClass("active");
          $(this).addClass("active");
          var pageIndex = parseInt($("#paginationBox .page.active a").html());
          getList();
        });
        // 下一页
        $(".page-next").click(function () {
          var pageIndex = parseInt($("#paginationBox .page.active a").html());
          if (pagesCount >= pageIndex + 1) {
            $("#paginationBox .page.active").next().addClass("active");
            $("#paginationBox .page")
              .eq(pageIndex - 1)
              .removeClass("active");
            getList();
          }
        });
        // 上一页
        $(".page-pre").click(function () {
          var pageIndex = parseInt($("#paginationBox .page.active a").html());
          if (pageIndex - 1 > 0) {
            $("#paginationBox .page.active").prev().addClass("active");
            $("#paginationBox .page")
              .eq(pageIndex - 1)
              .removeClass("active");
            getList();
          }
        });
      }
      // 创建表格
      function createTr(data) {
        if (!Array.isArray(data)) {
          // console.error("数据异常");
          return "";
        }

        var trs = [];
        // 没有数据时，插入空数据占位
        !data.length &&
          trs.push(
            '<tr class="txt-center"><td colspan="9">--没有数据--</td></tr>'
          );
        $(data).each(function (idx, item) {
          var target_day = item.create_at.split(" ")[0];
          var isWitness = item.status == 1;
          var witnessDetail =
            " <a style='color:#3498db' href='tables_design-z.html?id=" +
            item.id +
            "&target_day=" +
            target_day +
            "&type=view'> " +
            "见证详情</a>";

          var edit =
            " <a style='color:#3498db' href='tables_design-z.html?id=" +
            item.id +
            "&target_day=" +
            target_day +
            "&type=view' >" +
            (isWitness ? "查看" : "编辑") +
            "</a>";
          trs.push(
            "<tr> " +
              [
                "<td> " + item.create_at + "</td> ",
                "<td> " + item.project_id + "</td>",
                "<td> " + (item.classifyName || "-") + "</td>",
                "<td> " + (item.entrustName || "-") + "</td>",
                "<td> " + (item.witnessName || "-") + "</td>",
                "<td> " + (item.test_group || "-") + "</td>",
                "<td> " + (isWitness ? "已见证" : "非见证") + "</td>",
                "<td>" + edit + "</td>",
                "<td class='td-set'>" +
                  (isWitness ? witnessDetail : "") +
                  "</td>",
              ].join("") +
              "</tr> "
          );
        });

        $("#tableBody").html(trs.join(""));
      }

      //获取表格数据
      function getList() {
        var status = $("#status").val() || "";
        $.get(
          "http://meterial.cxhy.cn/getRecordList/",
          {
            status: status,
            target_month: $("#WHC_PayDate").val(), // 开始日期
            classifyId: opt_classify_id,
            page: pageIndex,
          },
          function (res) {
            var data = res.data;
            var total = data.length || 0;
            $(".total span").html(total);
            var pagesCount = parseInt(total) / 20;

            if (!$("#paginationBox").html()) {
              getPaginatLi(Math.ceil(pagesCount));
            }
            createTr(data);
          }
        );
      }
      // 取消见证
      $("document").on("click", "cancleWitness", function () {
        var id = $(this).attr("data-id");
        // cancelWitness/
        $.ajax({
          url: "http://meterial.cxhy.cn/cancelWitness/",
          type: "POST",
          dataType: "json",
          contentType: "application/json",
          data: JSON.stringify({
            id: id,
            target_day: $(this).attr("data-target_day"), // 开始日期
          }),
          success: function (res) {
            if (res.code == 200) {
              toastr && toastr.success("取消见证记录成功！");
              getList();
            }
          },
          error: function (error) {},
        });
      });

      $("#filterTableBtn").on("click", function () {
        getList();
      });

      // 点击打印
      $(".print").click(function () {
        $(".print-hide").hide();
        $("#tableFoot").hide();
        $(".print-wp").jqprint();
        $(".print-hide").show();
        $("#tableFoot").show();
      });
    </script>
  </body>
</html>
