<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Page title -->
    <title>HOMER | WebApp admin theme</title>

    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <!--<link rel="shortcut icon" type="image/ico" href="favicon.ico" />-->

    <!-- Vendor styles -->
    <link rel="stylesheet" href="vendor/fontawesome/css/font-awesome.css" />
    <link rel="stylesheet" href="vendor/metisMenu/dist/metisMenu.css" />
    <link rel="stylesheet" href="vendor/animate.css/animate.css" />
    <link rel="stylesheet" href="vendor/bootstrap/dist/css/bootstrap.css" />
    <link rel="stylesheet" href="vendor/toastr/build/toastr.min.css" />
    <link rel="stylesheet" href="vendor/sweetalert/lib/sweet-alert.css" />
    <link
      rel="stylesheet"
      href="vendor/bootstrap-datepicker-master/dist/css/bootstrap-datepicker3.min.css"
    />
    <link
      rel="stylesheet"
      href="vendor/awesome-bootstrap-checkbox/awesome-bootstrap-checkbox.css"
    />
    <link
      rel="stylesheet"
      href="vendor/clockpicker/dist/bootstrap-clockpicker.min.css"
    />
    <link
      rel="stylesheet"
      href="vendor/eonasdan-bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.min.css"
    />

    <!-- App styles -->
    <link
      rel="stylesheet"
      href="fonts/pe-icon-7-stroke/css/pe-icon-7-stroke.css"
    />
    <link rel="stylesheet" href="fonts/pe-icon-7-stroke/css/helper.css" />
    <link rel="stylesheet" href="styles/style.css" />
  </head>

  <body class="fixed-navbar">
    <!--[if lt IE 7]>
      <p class="alert alert-danger">
        You are using an <strong>outdated</strong> browser. Please
        <a href="http://browsehappy.com/">upgrade your browser</a> to improve
        your experience.
      </p>
    <![endif]-->

    <!-- Header -->
    <div id="header">
      <div class="color-line"></div>
      <!-- 常屏 项目名 -->
      <div id="logo" class="light-version">
        <span> 材料检验客户端 </span>
      </div>

      <!--  小屏 顶部导航 -->
      <nav role="navigation">
        <!-- <div class="header-link hide-menu"><i class="fa fa-bars"></i></div> -->
        <div class="small-logo">
          <span class="text-primary">材料检验客户端</span>
        </div>
        <!-- 常屏 顶部导航 -->
        <div class="navbar-right">
          <ul class="nav navbar-nav no-borders">
            <li class="dropdown">
              <a type="button" class="btn btn-text logoutBtn">
                <i class="pe-7s-upload pe-rotate-90"></i>
              </a>
            </li>
          </ul>
        </div>
      </nav>
    </div>

    <!-- Main Wrapper -->
    <div id="wrapper" class="m-n">
      <div class="content animate-panel content-width">
        <div class="hpanel">
          <div class="panel-heading">
            <ol class="breadcrumb m-n">
              <li><a href="./index-y.html">返回首页</a></li>
              <li><a href="#" onclick="goBack()">返回上一层</a></li>
            </ol>
          </div>
          <div class="row">
            <div id="contractTable" class="col-xs-12 col-md-12 col-lg-12">
              <div class="panel-body">
                <form
                  action="#"
                  id="loginForm1"
                  class="form-horizontal label-right"
                >
                  <div class="table-donwload-section">
                    <!-- 工程编号 -->
                    <div class="row">
                      <div
                        class="col-lg-12 table-order"
                        style="font-size: 12px; text-align: left"
                      ></div>
                    </div>
                    <div flex>
                      <!-- title -->
                      <div flex-box="1">
                        <h3
                          class="table-title txt-center"
                          style="
                            text-align: center;
                            height: 80px;
                            line-height: 80px;
                            padding-left: 100px;
                            font-size: 18px;
                          "
                        ></h3>
                      </div>
                      <!-- <div flex-box="0">
                        <img
                          src="http://meterial.cxhy.cn/static/images/a4.jpg"
                          width="100"
                          height="100"
                          style="display: inline-block"
                        />
                      </div> -->
                    </div>
                  </div>
                  <div class="row txt-center">
                    <button
                      type="button"
                      data-id="loginForm1"
                      class="btn w-xs btn-primary download"
                    >
                      下载
                    </button>
                    <button
                      type="button"
                      data-id="loginForm1"
                      class="btn w-xs btn-info print"
                    >
                      打印
                    </button>
                    <button
                      type="reset"
                      data-id="loginForm1"
                      class="btn w-xs btn-default resetBtn"
                    >
                      重置内容
                    </button>
                    <button
                      type="submit"
                      data-id="loginForm1"
                      class="btn w-xs btn-primary2 save"
                    >
                      保存
                    </button>
                    <button
                      type="button"
                      data-id="loginForm1"
                      class="btn w-xs btn-success record hidden"
                    >
                      生成见证记录
                    </button>
                  </div>
                </form>
              </div>
            </div>
            <div id="witnessTable" class="col-xs-12 col-md-12 col-lg-12 hidden">
              <div class="panel-body">
                <form
                  action="#"
                  id="loginForm2"
                  class="form-horizontal label-right"
                >
                  <div class="table-donwload-section">
                    <!-- 工程编号 -->
                    <div class="row">
                      <div
                        class="col-lg-12 table-order"
                        style="font-size: 12px; text-align: left"
                      ></div>
                    </div>
                    <div flex>
                      <!-- title -->
                      <div flex-box="1">
                        <h3
                          class="table-title txt-center"
                          style="
                            text-align: center;
                            height: 80px;
                            line-height: 80px;
                            font-size: 18px;
                          "
                        >
                          见证记录详情
                        </h3>
                      </div>
                    </div>
                  </div>
                  <div class="row txt-center">
                    <button
                      type="button"
                      data-id="loginForm2"
                      class="btn w-xs btn-info print"
                    >
                      打印
                    </button>
                    <button
                      type="button"
                      data-id="loginForm2"
                      class="btn w-xs btn-primary download"
                    >
                      下载
                    </button>

                    <button
                      type="button"
                      data-id="loginForm2"
                      class="btn w-xs btn-primary2 hidden cancleWitness"
                    >
                      取消见证
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
        <!-- 模版 -->
        <script type="text/template" id="tableTemp">
          <div class="no-border" style="text-align: center">
            <style type="text/css">
              .table-header tr th {
                /* border: 1px solid #fff; */
                /* text-align: left; */
                /* width: 16%; */
                padding: 0px;
              }
              .font-weight {
                  font-weight: 600;
              }
              .no-border {
                  border: 0;
              }
              .table-body {
                width: 100%;
                border: 1px solid #ccc;
                border-bottom: 0;
                border-collapse: collapse;
              }

              .table-body tr td,
              .table-body tr th {
                width: 16%;
                  border-right: 1px solid #ccc;
                  border-bottom: 1px solid #ccc;
                  font-size: 12px;
                  height: 30px;
              }

              .table-header {
                /* border: 1px solid #fff; */
                font-size: 12px;
                width: 100%;
              }

              .table-desc {
                font-size: 12px;
                word-wrap: break-word;
                margin-top: 10px;
                text-align: left;
              }

              .checkbox-wp {
                text-align: left;
                margin-left: 10px;
              }

              .txt-center {
                  text-align: center;
              }
              .txt-left {
                  text-align: left;
              }
              .txt-right {
                  text-align: right;
              }

              [flex] {
                display: -webkit-box;
                display: -webkit-flex;
                display: -ms-flexbox;
                display: flex;
              }

              [flex-box="0"] {
                -webkit-box-flex: 0;
                -webkit-flex-grow: 0;
                -ms-flex-positive: 0;
                flex-grow: 0;
                -webkit-flex-shrink: 0;
                -ms-flex-negative: 0;
                flex-shrink: 0;
              }

              [flex-box="1"] {
                -webkit-box-flex: 1;
                -webkit-flex-grow: 1;
                -ms-flex-positive: 1;
                flex-grow: 1;
                -webkit-flex-shrink: 1;
                -ms-flex-negative: 1;
                flex-shrink: 1;
              }
              #loginForm2 table tr th,
              #loginForm2 table tr td {
                  height: 46px;
                  line-height:23px;
              }
              .table-donwload-section label {
                  font-weight: 500;
              }
            </style>
            <!-- 测试图片 -->
            <!-- <img src="./images/a1.jpg" alt="" srcset="" crossorigin="anonymous"> -->
            <!-- <img src="./images/a1.jpg" alt="" srcset=""> -->

            <!-- 表头 -->
            <table class="table-header">
              __TABLE_HEADER__
            </table>
            <!-- 表体 -->
            <table class="table-body" align="center">
              <tbody>
                __TABLE_BODY
              </tbody>
            </table>
            <!-- 备注 -->
            <div class="row">
              <div
                class="col-lg-12 table-desc"
                style="
                  font-size: 12px;
                  word-wrap: break-word;
                  margin: 10px 0;
                  text-align: left;
                "
              >
                __TABLE_DESC
              </div>
            </div>
          </div>
        </script>
      </div>
    </div>

    <!-- Vendor scripts -->
    <script src="vendor/jquery/dist/jquery.min.js"></script>
    <script src="vendor/jquery-ui/jquery-ui.min.js"></script>
    <script src="vendor/slimScroll/jquery.slimscroll.min.js"></script>
    <script src="vendor/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="vendor/metisMenu/dist/metisMenu.min.js"></script>
    <script src="vendor/iCheck/icheck.min.js"></script>
    <script src="vendor/sparkline/index.js"></script>
    <script src="vendor/moment/moment.js"></script>
    <script src="vendor/files/FileSaver.js"></script>
    <script src="vendor/files/jquery.wordexport.js"></script>
    <script src="vendor/bootstrap-datepicker-master/dist/js/bootstrap-datepicker.min.js"></script>
    <script src="vendor/clockpicker/dist/bootstrap-clockpicker.min.js"></script>
    <script src="vendor/eonasdan-bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script>
    <script src="vendor/toastr/build/toastr.min.js"></script>
    <script src="vendor/jquery-validation/jquery.validate.min.js"></script>
    <script src="vendor/sweetalert/lib/sweet-alert.min.js"></script>

    <!-- App scripts -->
    <script src="scripts/jquery.base64.js"></script>
    <script src="scripts/jquery.jqprint-0.3.js"></script>
    <script src="scripts/homer.js"></script>
    <script src="scripts/dataToTable.js"></script>
    <script>
      // 解决打印报错
      jQuery.browser = {};
      (function () {
        jQuery.browser.msie = false;
        jQuery.browser.version = 0;
        if (navigator.userAgent.match(/MSIE ([0-9]+)./)) {
          jQuery.browser.msie = true;
          jQuery.browser.version = RegExp.$1;
        }
      })();
    </script>
    <script>
      var userInfo = getUserInfo() || {};
      var queryObj = query2obj(window.location.href);
      //   编辑初始
      var exclusiveClass = "col-xs-12 col-md-12 col-lg-12";
      var averageClass = "col-xs-12 col-md-12 col-lg-6";
      var isEdit = !!queryObj.id;
      var iscontract = queryObj.type === "contract";
      var isWitness = queryObj.type === "witness";
      var createWitnessId = "";

      // contractTable
      // witnessTable
      // 这里用原生，方便直接替换类名
      var contractTableEle = document.getElementById("contractTable");
      var witnessTableEle = document.getElementById("witnessTable");
      if (isWitness) {
        contractTableEle.className = averageClass;
        witnessTableEle.className = averageClass;
      }
      //   record
      //   编辑状态，置灰重置按钮
      //   type暂设置。1：有操作权限 ，2有查看权限， 3
      if (isEdit) {
        $(".save").html("编辑");
        // if (userInfo.type == 2) {
        $(".record").removeClass("hidden");
        $(".cancleWitness").removeClass("hidden");
        // }
      }
      //   生成表格校验信息
      var loginForm1Map = {
        rules: {},
        messages: {},
      };
      var loginForm2Map = {
        rules: {},
        messages: {},
      };
      var tableName = "";
      var tableNum = "";
      console.log('userInfo', userInfo)
      // classify_name: "螺纹钢"
      // create_at: "2021-05-24T18:31:23"
      // form_id: 1
      // id: 10
      // items: []
      // level: 2
      // order_id: 1
      // parent_id: 2
      // update_at: "2021-05-24T18:31:25"
      var form_style_query = JSON.parse(localStorage.getItem("form_style_query"));
      var formStyle = {
        token:	userInfo.token, //	Y	用户临时标识
        form_id: 	queryObj.form_id || 1, // 	Y	表格样式id
        classifyId:	10, // 	Y	分类id
      }
      var formData = Object.assign(formStyle, form_style_query)
      
      $.ajax({
        url: "http://meterial.cxhy.cn/getFormStyle/",
        dataType: "json",
        contentType: "application/json",
        type:"POST",
        data: JSON.stringify(formData),
        success: function (res) {
          if (res.code == 200) {
            if (isEdit && res.data.status == 1) {
              $(".record").addClass("hidden");
              // $(".cancleWitness").removeClass("hidden");
            }
            var data = res.data;
            // 工程编号
            tableNum = data.numbers;
            tableName = data.title;
            $("#loginForm1 .table-donwload-section .table-order").html(
              data.numbers
            );
            // title 信息
            $("#loginForm1 .table-donwload-section .table-title").html(
              data.title
            );
            // 表头信息
            if (data.tableData) {
              data.tableData.forEach(function (item) {
                dataToTable(item, "#loginForm1", loginForm1Map);
                saveFn();
              });
            }
            if (data.witnessData && data.witnessData.tableData) {
              createWitnessId = data.witnessData.id;
              data.witnessData.tableData.forEach(function (item) {
                dataToTable(item, "#loginForm2", loginForm2Map);
                // saveFn();
              });
            }

            //最后的错误信息
            res.msg && res.msg != "ok" && toastr && toastr.warning(res.msg);
          }
        },
      });
      
      // $.ajax({
      //   url: isEdit
      //     ? "http://meterial.cxhy.cn/getRecordDetail/"
      //     : "http://meterial.cxhy.cn/getFormStyle/",
      //     dataType: "json",
      //     contentType: "application/json",
      //   type: isEdit ? "GET" : "POST",
      //   data: isEdit
      //     ? {
      //         id: queryObj.id,
      //         target_day: queryObj.target_day,
      //       }
      //     : {
      //         form_id: queryObj.form_id || 1,
      //       },
      //   success: function (res) {
      //     if (res.code == 200) {
      //       if (isEdit && res.data.status == 1) {
      //         $(".record").addClass("hidden");
      //         // $(".cancleWitness").removeClass("hidden");
      //       }
      //       var data = res.data;
      //       // 工程编号
      //       tableNum = data.numbers;
      //       tableName = data.title;
      //       $("#loginForm1 .table-donwload-section .table-order").html(
      //         data.numbers
      //       );
      //       // title 信息
      //       $("#loginForm1 .table-donwload-section .table-title").html(
      //         data.title
      //       );
      //       // 表头信息
      //       if (data.tableData) {
      //         data.tableData.forEach(function (item) {
      //           dataToTable(item, "#loginForm1", loginForm1Map);
      //           saveFn();
      //         });
      //       }
      //       if (data.witnessData && data.witnessData.tableData) {
      //         createWitnessId = data.witnessData.id;
      //         data.witnessData.tableData.forEach(function (item) {
      //           dataToTable(item, "#loginForm2", loginForm2Map);
      //           // saveFn();
      //         });
      //       }

      //       //最后的错误信息
      //       res.msg && res.msg != "ok" && toastr && toastr.warning(res.msg);
      //     }
      //   },
      // });

      // 点击下载
      $(".download").click(function () {
        var parentId = $(this).attr("data-id");
        changeImgToDataurl();
        // 处理输入框内容替换
        var entrys = $("#" + parentId).find("input[type='text']");
        var selects = $("#" + parentId).find('input[type="checkbox"]');
        entrys = Array.prototype.slice.call(entrys);
        entrys.forEach(function (inputEle) {
          // inputEle.checked
          var val = $(inputEle).val() || "";
          $(inputEle).siblings(".placeholder").text(val);
        });

        selects.each(function (idx, inputEle) {
          var checked = inputEle.checked;
          $(inputEle)
            .siblings(".placeholder")
            .text(checked ? "■" : "□");
        });

        $(".table-donwload-section").wordExport(
          tableNum + (parentId == "loginForm2" ? "见证记录" : tableName)
        );
        entrys.forEach(function (inputEle) {
          var val = $(inputEle).val() || "";
          $(inputEle).siblings(".placeholder").text("");
        });
      });
      // 点击保存
      function saveFn() {
        $("#loginForm1").validate({
          rule: loginForm1Map.rule,
          messages: loginForm1Map.messages,
          submitHandler: function () {
            var datas = $("#loginForm1").serializeArray();
            var submitData = {};
            $(datas).each(function (idx, item) {
              //   debugger;
              var already = submitData[item.name] || "";
              submitData[item.name] =
                (already ? already + "," : "") + $.trim(item.value) || "";
            });

            var params = {
              form_id: queryObj.form_id || 1,
              project_id: userInfo.project_cid || "",
              form_data: $.base64.encode(JSON.stringify(submitData), "UTF-8"), // checkbox 只有选中的才会提交
              target_day: ymd(), // 获取当前年月日
            };
            isEdit && (params.record_id = queryObj.id);

            $.ajax({
              url: "http://meterial.cxhy.cn/saveFormRecord/",
              type: "POST",
              dataType: "json",
              contentType: "application/json",
              data: JSON.stringify(params),
              success: function (res) {
                if (res.code == 200) {
                  toastr && toastr.success("合同保存成功");
                  setTimeout(function () {
                    window.location.href = "./index-y.html";
                  }, 1000);
                }
              },
              error: function (error) {},
            });
          },
        });
      }

      //非编辑才添加事件 点击生成见证记录
      $(".record").click(function () {
        contractTableEle.className = averageClass;
        witnessTableEle.className = averageClass;
        var params = {
          record_id: queryObj.id, //  $("#loginForm1 .table-wp .table-order").html(),
          target_day: ymd(), // 获取当前年月日
        };
        $.ajax({
          url: "http://meterial.cxhy.cn/generateWitness/",
          type: "POST",
          dataType: "json",
          contentType: "application/json",
          data: JSON.stringify(params),
          success: function (res) {
            if (res.code == 200) {
              createWitnessId = res.data.id || "";
              res.data.tableData.forEach(function (item) {
                dataToTable(item, "#loginForm2", loginForm2Map);
              });
              //   不刷新 向路由中添加参数，刷新后，保持功能
              if (iscontract) {
                queryObj.type = "witness";
                // queryObj.id = res.data.id;
                var query = obj2query(queryObj);
                query = "?" + query;
                setTimeout(function () {
                  if (window.history) {
                    // 支持History API
                    history.replaceState(null, "", query);
                  }
                });
              }
              //点击过生成见证记录后，置灰
              $(".record").addClass("hidden");
              //   !isEdit && window.location.search;
            }
          },
          error: function (error) {},
        });
      });
      // 点击打印
      $(".print").click(function () {
        var fromId = $(this).attr("data-id");
        $("#" + fromId)
          .find(".table-donwload-section")
          .jqprint();
      });

      $(".cancleWitness").on("click", function () {
        $.ajax({
          url: "http://meterial.cxhy.cn/cancelWitness/",
          type: "POST",
          dataType: "json",
          contentType: "application/json",
          data: JSON.stringify({
            id: queryObj.id,
            target_day: ymd(),
          }),
          success: function (res) {
            if (res.code == 200) {
              toastr && toastr.success("取消见证记录成功！");
              //   恢复委托表独占
              contractTableEle.className = exclusiveClass;
              witnessTableEle.className = exclusiveClass + " hidden";
              $(".record").removeClass("hidden");
              if (window.history) {
                queryObj = query2obj(window.location.href);
                queryObj.type = "contract";
                var query = obj2query(queryObj);
                query = "?" + query;
                // 支持History API
                history.replaceState(null, "", query);
              }
            }
          },
          error: function (error) {},
        });
      });
    </script>
  </body>
</html>
