<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Page title -->
    <title>表单编辑</title>

    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <!--<link rel="shortcut icon" type="image/ico" href="favicon.ico" />-->

    <!-- Vendor styles -->
    <link rel="stylesheet" href="vendor/fontawesome/css/font-awesome.css" />
    <link rel="stylesheet" href="vendor/metisMenu/dist/metisMenu.css" />
    <link rel="stylesheet" href="vendor/animate.css/animate.css" />
    <link rel="stylesheet" href="vendor/bootstrap/dist/css/bootstrap.css" />
    <link rel="stylesheet" href="vendor/toastr/build/toastr.min.css" />
    <link rel="stylesheet" href="vendor/sweetalert/lib/sweet-alert.css" />
    <link
      rel="stylesheet"
      href="vendor/bootstrap-datepicker-master/dist/css/bootstrap-datepicker3.min.css"
    />
    <link
      rel="stylesheet"
      href="vendor/awesome-bootstrap-checkbox/awesome-bootstrap-checkbox.css"
    />
    <link
      rel="stylesheet"
      href="vendor/clockpicker/dist/bootstrap-clockpicker.min.css"
    />
    <link
      rel="stylesheet"
      href="vendor/eonasdan-bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.min.css"
    />

    <!-- App styles -->
    <link
      rel="stylesheet"
      href="fonts/pe-icon-7-stroke/css/pe-icon-7-stroke.css"
    />
    <link rel="stylesheet" href="fonts/pe-icon-7-stroke/css/helper.css" />
    <link rel="stylesheet" href="styles/style.css" />
    <link rel="stylesheet" href="styles/flex.css" />
  </head>

  <body class="fixed-navbar">
    <!--[if lt IE 7]>
      <p class="alert alert-danger">
        You are using an <strong>outdated</strong> browser. Please
        <a href="http://browsehappy.com/">upgrade your browser</a> to improve
        your experience.
      </p>
    <![endif]-->

    <!-- Header -->
    <div id="header">
      <div class="color-line"></div>
      <!-- 常屏 项目名 -->
      <div id="logo" class="light-version">
        <span> 材料检验客户端 </span>
      </div>

      <!--  小屏 顶部导航 -->
      <nav role="navigation">
        <!-- <div class="header-link hide-menu"><i class="fa fa-bars"></i></div> -->
        <div class="small-logo">
          <span class="text-primary">材料检验客户端</span>
        </div>
        <div class="mobile-menu">
          <button
            type="button"
            class="navbar-toggle mobile-menu-toggle"
            data-toggle="collapse"
            data-target="#mobile-collapse"
          >
            <i class="fa fa-chevron-down"></i>
          </button>
          <div class="collapse mobile-navbar" id="mobile-collapse">
            <ul class="nav navbar-nav">
              <!-- <li>
                <a class="" href="login.html">Login</a>
              </li> -->
              <li>
                <a type="button" class="btn btn-text logoutBtn">Logout</a>
              </li>
            </ul>
          </div>
        </div>
        <!-- 面包线 -->
        <div id="hbreadcrumb" class="m-b-n-i">
          <ol class="hbreadcrumb breadcrumb">
            <li><a href="index.html">首页</a></li>
            <li>
              <a href="create_form.html">新建表单</a>
            </li>
            <li class="active">
              <span>新建表单</span>
            </li>
          </ol>
        </div>
        <!-- 常屏 顶部导航 -->
        <div class="navbar-right">
          <ul class="nav navbar-nav no-borders">
            <li class="word-no-wp">
              <span>工程编号：</span>
              <span class="word-no"></span>
            </li>
            <li class="dropdown">
              <a type="button" class="btn btn-text logoutBtn">
                <i class="pe-7s-upload pe-rotate-90"></i>
              </a>
            </li>
          </ul>
        </div>
      </nav>
    </div>

    <!-- Main Wrapper -->
    <div id="wrapper" class="m-n">
      <div class="content animate-panel content-width">
        <div class="hpanel">
          <!-- class="row"flex="" -->
          <div id="mainWrapper" class="ovh">
            <!-- class="col-xs-12 col-md-12 col-lg-12" -->
            <div
              id="contractTable"
              class="p-r-sm col-xs-12 col-md-12 col-lg-12"
            >
              <div class="panel-body">
                <form
                  action="#"
                  id="loginForm1"
                  class="form-horizontal label-right"
                >
                  <div class="table-donwload-section">
                    <!-- 工程编号 -->
                    <div class="row">
                      <!-- <div
                        class="col-lg-12 table-order"
                        style="font-size: 12px; text-align: left"
                      ></div> -->
                    </div>
                    <!-- title -->
                    <div
                      style="overflow: hidden; width: 100%; text-align: justify"
                    >
                      <div
                        class="qr-code code-pos hidden"
                        style="text-align: right"
                      >
                        <img
                          src=""
                          alt=""
                          class="contract-code"
                          width="80px"
                          height="80px"
                        />
                      </div>
                      <p
                        class="table-desc-info txt-center"
                        style="text-align: center"
                      ></p>
                    </div>
                    <div flex></div>
                  </div>
                  <div class="row txt-center">
                    <button
                      type="button"
                      data-id="loginForm1"
                      class="btn w-xs btn-primary download m-b"
                    >
                      下载
                    </button>
                    <a
                      tabindex="0"
                      class="btn w-xs btn-info m-l-lg m-b print"
                      data-id="loginForm1"
                      role="button"
                      >打印</a
                    >
                    <button
                      type="reset"
                      data-id="loginForm1"
                      class="btn w-xs btn-default resetBtn m-l-lg m-b"
                    >
                      重置内容
                    </button>
                    <button
                      type="button"
                      data-id="loginForm1"
                      class="btn w-xs btn-primary2 save m-l-lg m-b"
                    >
                      保存
                    </button>
                    <button
                      type="button"
                      data-id="loginForm1"
                      class="
                        btn
                        w-xs
                        btn-primary2
                        contractEdit
                        m-l-lg m-b
                        hidden
                      "
                    >
                      编辑
                    </button>
                    <button
                      type="button"
                      data-id="loginForm1"
                      class="btn w-xs btn-success record hidden m-l-lg m-b"
                    >
                      保存见证记录
                    </button>
                    <button
                      type="button"
                      data-id="loginForm1"
                      class="btn w-xs btn-default print-code m-l-lg m-b hidden"
                    >
                      打印二维码
                    </button>
                  </div>
                </form>
              </div>
            </div>
            <!-- class="col-xs-12 col-md-12 col-lg-12 hidden" -->
            <div id="witnessTable" class="col-xs-12 col-md-12 col-lg-12 hidden">
              <div class="panel-body">
                <form
                  action="#"
                  id="loginForm2"
                  class="form-horizontal label-right"
                >
                  <div class="table-donwload-section">
                    <!-- <div class="qr-code code-pos" style="text-align: right">
                      <img
                        src=""
                        alt=""
                        class="witness-code"
                        width="80px"
                        height="80px"
                      />
                    </div> -->
                  </div>
                  <div class="row txt-center">
                    <button
                      type="button"
                      data-id="loginForm2"
                      class="btn w-xs btn-info print"
                    >
                      打印
                    </button>
                    <button
                      type="button"
                      data-id="loginForm2"
                      class="btn w-xs btn-primary download m-l-lg"
                    >
                      下载
                    </button>

                    <button
                      type="button"
                      data-id="loginForm2"
                      class="btn w-xs btn-primary2 witnessEidt m-l-lg"
                    >
                      修改
                    </button>
                    <button
                      type="button"
                      data-id="loginForm2"
                      class="btn w-xs btn-primary2 hidden witnessSave m-l-lg"
                    >
                      保存
                    </button>
                    <button
                      type="button"
                      data-id="loginForm2"
                      class="btn w-xs btn-default print-code m-l-lg"
                    >
                      打印二维码
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
        <!-- 模版 -->
        <script type="text/template" id="tableTemp">
          <div class="no-border form-apend-block" style="text-align: center">
            <style type="text/css">
              .table-header tr th {
                border: 1px solid #fff;
                text-align: left;
                /* width: 12.5%; */
                font-size: 13.2px;
                /* padding: 0px; */

              }
              .font-weight {
                  /* font-weight: 600; */
              }
              .label-text {
                font-family:'Microsoft Yahei', SimHei;

              }
              .no-border {
                  border: 0;
              }
              .table-body {
                width: 100%;
                border: 1px solid #000;
                border-bottom: 0;
                border-collapse: collapse;
              }

              .table-body tr td,
              .table-body tr th {
                  /* width: 16%; */
                  border-right: 1px solid #000;
                  border-bottom: 1px solid #000;
                  font-size: 13.2px;
                  height:28px;
                  font-family:NSimSun,SimSun;
                  min-width: 70px;
              }
              .table-body tr{
                height: 28px;
              }

              .table-header {
                border: 1px solid #fff;
              }

              .p-xs {
                padding: 0 5px
              }
              .table-desc {
                font-size: 12px;
                word-wrap: break-word;
                margin-top: 10px;
                text-align: left;
              }

              .checkbox-wp {
                text-align: left;
                margin-left: 10px;
              }

              .txt-center {
                  text-align: center;
              }
              .txt-left {
                  text-align: left;
              }
              .txt-right {
                  text-align: right;
              }
              textarea {
                width:100%;
                border: 0px;
                outline: none;
                margin: 0px;
              }

              [flex] {
                display: -webkit-box;
                display: -webkit-flex;
                display: -ms-flexbox;
                display: flex;
              }

              [flex-box="0"] {
                -webkit-box-flex: 0;
                -webkit-flex-grow: 0;
                -ms-flex-positive: 0;
                flex-grow: 0;
                -webkit-flex-shrink: 0;
                -ms-flex-negative: 0;
                flex-shrink: 0;
              }

              [flex-box="1"] {
                -webkit-box-flex: 1;
                -webkit-flex-grow: 1;
                -ms-flex-positive: 1;
                flex-grow: 1;
                -webkit-flex-shrink: 1;
                -ms-flex-negative: 1;
                flex-shrink: 1;
              }
              .table-win tr:first-child {
                height: 80px !important;
              }
              .table-win tr th,
              .table-win tr td {
                  /* height: 23px;
                  line-height:23px; */
                  font-size: 14px;
                  /* font-family:"SimHei"; */
                  text-align:center;
              }
              .table-win tr td .jz-str1{
                  font-size: 22.5px;
                  font-family:"SimHei";
                  /* line-height: 2; */
              }
              .table-win tr td .jz-str2{
                  font-size: 16px;
                  font-family:"SimHei";
                  /* line-height: 2; */
              }
              .table-win tr td .b-border{
                  display:inline-block;
                  width: 30px;
                  border-bottom:1px solid #000;
              }
              .table-donwload-section label {
                  /* font-weight: 500; */
              }
              .table-win{
                /* border: 2px solid #000; */
              }

             .table-win tr td,
              .table-win tr th{
                font-size: 13.2px !important;
                height: 30px;
                width: 200px;
              }
              .table-win td div{
                text-align:center !important;
              }
              .tr-line1{
                height: 30px;
              }
              .tr-line4{
                height: 100px;
              }
              .table-body tr td .class-step{
                outline: none;
                border: none;
                display: inline-block;
                width: 20px;
                border-bottom:1px solid #000;
              }
            </style>
            <!-- 测试图片 -->
            <!-- <img src="./images/a1.jpg" alt="" srcset="" crossorigin="anonymous"> -->
            <!-- <img src="./images/a1.jpg" alt="" srcset=""> -->

            <!-- 表头 -->
            <table class="table-header">
              __TABLE_HEADER__
            </table>
            <!-- 表体 -->
            <table class="table-body" align="center">
              <!-- <thead>
                <tr>
                  <th style="width: 16.67%">Name</th>
                  <th style="width: 16.67%">Phone</th>
                  <th style="width: 16.67%">Street Address</th>
                  <th style="width: 16.67%">City</th>
                  <th style="width: 16.67%">Country</th>
                  <th style="width: 16.67%">Country</th>
              </tr>
              </thead> -->
              <tbody>
                __TABLE_BODY
              </tbody>
            </table>
            <!-- 备注 -->
            <div class="row">
              <div
                class="col-lg-12 table-desc"
                style="
                  font-size: 12px;
                  word-wrap: break-word;
                  margin: 10px 0;
                  text-align: left;
                "
              >
                __TABLE_DESC
              </div>
            </div>
          </div>
        </script>
      </div>
    </div>
    <!-- Vendor scripts -->
    <script src="vendor/jquery/dist/jquery.min.js"></script>
    <script src="vendor/jquery-ui/jquery-ui.min.js"></script>
    <script src="vendor/slimScroll/jquery.slimscroll.min.js"></script>
    <script src="vendor/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="vendor/metisMenu/dist/metisMenu.min.js"></script>
    <script src="vendor/iCheck/icheck.min.js"></script>
    <script src="vendor/sparkline/index.js"></script>
    <script src="vendor/moment/moment.js"></script>
    <script src="vendor/files/FileSaver.js"></script>
    <script src="vendor/files/jquery.wordexport.js"></script>
    <script src="vendor/bootstrap-datepicker-master/dist/js/bootstrap-datepicker.min.js"></script>
    <script src="vendor/clockpicker/dist/bootstrap-clockpicker.min.js"></script>
    <script src="vendor/eonasdan-bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script>
    <script src="vendor/toastr/build/toastr.min.js"></script>
    <script src="vendor/jquery-validation/jquery.validate.min.js"></script>
    <script src="vendor/sweetalert/lib/sweet-alert.min.js"></script>

    <!-- App scripts -->
    <script src="scripts/jquery.base64.js"></script>
    <script src="scripts/jquery.jqprint-0.3.js"></script>
    <script src="scripts/homer.js"></script>
    <script src="scripts/dataToTable.js"></script>
    <script src="scripts/zh.js"></script>
    <script>
      // 解决打印报错
      jQuery.browser = {};
      (function () {
        jQuery.browser.msie = false;
        jQuery.browser.version = 0;
        if (navigator.userAgent.match(/MSIE ([0-9]+)./)) {
          jQuery.browser.msie = true;
          jQuery.browser.version = RegExp.$1;
        }
      })();
      var popoverTemplate =
        "<div>\
          打印需要手动再【更多设置】中适配边距和行高，适应A4纸张大小！\
          <div>1、边距：【行距】=> 【自定义】拖拽文稿预览区域的边距线调整打印边距</div>\
          <div>2、打印一页：【缩放】=>【自定义】调整打印区域</div>\
          </div>";

      $(".print").popover({
        // selector: ".print",
        trigger: "hover",
        content: popoverTemplate,
        // template: popoverTemplate,
        placement: "top",
        title: "打印设置",
        html: true,
      });
    </script>
    <script>
      var userInfo = getUserInfo() || {};
      var queryObj = query2obj(window.location.href);
      //   编辑初始
      var exclusiveClass = "col-xs-12 col-md-12 col-lg-12";
      var averageClass = "col-xs-12 col-md-12 col-lg-6";
      var isId = !!queryObj.id; // url上带id字段都可编辑
      // var iscontract = queryObj.type === "contract"; // 从首页点击"合同详情"跳转过来
      // var isWitness = queryObj.type === "witness"; // 从首页点击"见证详情" 跳转过来
      var ctEdit = queryObj.type === "contractEdit"; // 从首页点击"编辑" 跳转过来
      var wnEdit = queryObj.type === "witnessEdit"; // 从首页点击"编辑" 跳转过来
      var isView = queryObj.type === "view"; // 查看状态
      var isCreate = queryObj.type === "create"; // 创建表单
      var isSubmit = false;
      // var mainWrapper = document.getElementById("mainWrapper");
      // var mainWrapper = document.getElementById("mainWrapper");
      // var mainWrapper = document.getElementById("mainWrapper");
      var contractTable = $("#contractTable");
      var witnessTable = $("#witnessTable");
      var contractEdit = $(".contractEdit"); // 合同编辑按钮
      var contractSave = $(".save"); // 合同编辑按钮
      var witnessEidt = $(".witnessEidt"); // 合同编辑按钮
      var witnessSave = $(".witnessSave"); // 合同编辑按钮

      var createWitnessId = "";
      var nullTable = JSON.stringify({
        tableHead: [],
        tableBody: [],
        desc: null,
      }); // 空表对比模板

      // 按钮更新
      isView &&
        (contractSave.addClass("hidden"), contractEdit.removeClass("hidden"));
      isCreate && $(".print").addClass("hidden");

      isId && $(".record").removeClass("hidden");
      // 委托合同编辑
      if (ctEdit) {
        contractEdit.addClass("hidden");
        contractSave.removeClass("hidden");
        witnessSave.addClass("hidden");
        witnessEidt.removeClass("hidden");
      }
      // 见证记录编辑
      if (wnEdit) {
        witnessSave.removeClass("hidden");
        witnessEidt.addClass("hidden");
        contractEdit.removeClass("hidden");
        contractSave.addClass("hidden");
      }

      //   生成表格校验信息
      var loginForm1Map = {
        rules: {},
        messages: {},
      };
      var loginForm2Map = {
        rules: {},
        messages: {},
      };
      var tableName = "";
      var tableNum = "";
      var form_style_query = JSON.parse(
        localStorage.getItem("form_style_query")
      );
      var formStyle = {
        token: userInfo.token, //	Y	用户临时标识
        form_id: queryObj.form_id || 8, // 	Y	表格样式id
        classifyId: queryObj.classifyId, // 	Y	分类id
      };
      // key, v
      function updateUrlParams(payload) {
        var payload = payload || {};
        if (window.history) {
          var urlParams = query2obj(window.location.href);
          for (var key in payload) {
            if (!payload[key]) {
              delete urlParams[key];
            } else {
              urlParams[key] = payload[key];
            }
          }
          var query = "?" + obj2query(urlParams);
          history.replaceState(null, "", query);
        }
        window.location.reload();
      }

      // 初始合同表格信息
      function updateCtInit(data, isEdit, isWitness) {
        // 工程编号
        tableNum = data.numbers;
        tableName = data.title;
        document.title = tableName;
        // 设置面包线
        $("#hbreadcrumb .active").find("span").html(tableName);
        // $("#loginForm1 .table-donwload-section .table-order").html(
        //   data.numbers
        // );
        // title 信息
        $("#loginForm1 .table-donwload-section .table-desc-info").html(
          tableName
        );
        // 表头信息
        if (data.tableData) {
          data.tableData.forEach(function (item) {
            if (nullTable != JSON.stringify(item)) {
              if (!isEdit) {
                dataToTable(item, "#loginForm1", loginForm1Map, data);
              } else {
                dataToTable(
                  item,
                  "#loginForm1",
                  loginForm1Map,
                  data,
                  false,
                  isWitness
                );
                !isWitness && $(".resetBtn").addClass("hidden");
              }
            }
          });
        }
      }

      var formData = Object.assign(formStyle, form_style_query);
      if (!isId) {
        $.ajax({
          url: "http://meterial.cxhy.cn/getFormStyle/",
          dataType: "json",
          contentType: "application/json",
          type: "POST",
          data: JSON.stringify(formData),
          success: function (res) {
            if (res.code == 200) {
              var data = res.data;
              // 初始化表格
              updateCtInit(data);
              //最后的错误信息
              res.msg && res.msg != "ok" && toastr && toastr.warning(res.msg);
            }
          },
        });
      }

      if (isId) {
        $.ajax({
          url: "http://meterial.cxhy.cn/getRecordDetail/",
          type: "GET",
          data: {
            id: queryObj.id,
            target_day: queryObj.target_day,
            qr_code_obj: {
              contract: "./qr-code.html?" + obj2query(queryObj) + "&witness=0",
              witness: "./qr-code.html?" + obj2query(queryObj) + "&witness=1",
            },
          },
          success: function (res) {
            if (res.code == 200) {
              var data = res.data;
              var isWitness = data.status == 1;
              //  有见证表，调整布局
              if (isWitness) {
                contractTable.removeClass("col-lg-12").addClass("col-lg-7");
                witnessTable
                  .removeClass("col-lg-12 ")
                  .addClass("col-lg-5")
                  .removeClass("hidden");
                [".record", ".resetBtn"].forEach(function (ele) {
                  $(ele).addClass("hidden");
                });
              }

              updateCtInit(data, true, isWitness);

              if (isWitness) {
                createWitnessId = data.witnessData.id;
                data.witnessData.tableData.forEach(function (item) {
                  if (nullTable != JSON.stringify(item)) {
                    dataToTable(
                      item,
                      "#loginForm2",
                      loginForm2Map,
                      data,
                      false,
                      isWitness
                    );
                  }
                });
              }
              // 二维码
              if (data.qrCode) {
                if (data.qrCode.contract) {
                  $(".contract-code").parent().removeClass("hidden");
                  $(".contract-code").attr("src", data.qrCode.contract);
                  $("#loginForm1 .print-code").removeClass("hidden");
                }
                if (data.qrCode.witness) {
                  $(".witness-code").attr("src", data.qrCode.witness);
                }
              }
              //最后的错误信息
              res.msg && res.msg != "ok" && toastr && toastr.warning(res.msg);
            }
          },
        });
      }

      // 点击下载
      $(".download").click(function () {
        var parentId = $(this).attr("data-id");
        var htmlStr = $("#" + parentId).clone(true);
        $("#" + parentId)
          .find("tr, th")
          .attr("style", "height:40px");
        replaceEl(parentId, "download");
        $("#" + parentId)
          .find(".table-donwload-section")
          .wordExport(
            tableNum + (parentId == "loginForm2" ? "见证记录" : tableName)
          );
        var stepWp = $("#loginForm1 label").hasClass("step-wp");
        if (stepWp) {
          $("#loginForm1 .step-wp>div").eq(0).addClass("hidden");
          $("#loginForm1 .step-wp>div").eq(1).removeClass("hidden");
        }
        $("#" + parentId).html(htmlStr);
      });
      // 点击保存
      $(".save").click(function () {
        $("#loginForm1 .no-border:eq(1)").append(
          '<p style="text-align:right">生效时间：' + ymd() + "</p>"
        );
        saveFn();
      });

      function saveFn(isInit) {
        setpFn("loginForm1", "download");
        queryObj = query2obj(window.location.href);
        $("#loginForm1").validate({
          rule: loginForm1Map.rule,
          messages: loginForm1Map.messages,
          submitHandler: function () {
            isSubmit = true;
            var datas = $("#loginForm1").serializeArray();

            var radios = $("#loginForm1").find('input[type="radio"]');
            radios.each(function (idx, inputEle) {
              var checked = inputEle.checked;
              var sid = $(inputEle).attr("sid");
              var val = checked ? $(inputEle).val() : "";
              datas.push({ name: sid, value: val });
            });
            var submitData = {};
            $(datas).each(function (idx, item) {
              //   debugger;
              var already = submitData[item.name] || "";
              submitData[item.name] =
                (already ? already + "," : "") + $.trim(item.value) || "";
            });
            datas[$("#loginForm1 .step-wp").attr("data-sid")] = $(
              "#loginForm1 .step-wp"
            ).html(); // 替换第几部的值
            // debugger;
            var params = {
              classifyId: queryObj.classifyId || 1,
              form_id: queryObj.form_id || 1,
              project_id: userInfo.project_cid || "",
              form_data: $.base64.encode(JSON.stringify(submitData), "UTF-8"), // checkbox 只有选中的才会提交
              target_day: queryObj.target_day, // 获取当前年月日
            };
            isId && (params.record_id = queryObj.id);
            $.ajax({
              url: "http://meterial.cxhy.cn/saveFormRecord/",
              type: "POST",
              dataType: "json",
              contentType: "application/json",
              data: JSON.stringify(params),
              success: function (res) {
                console.log("id", res.data.record_id);
                if (res.code == 200) {
                  toastr &&
                    toastr.success(isId ? "合同编辑成功" : "合同保存成功");
                  var params = {
                    id: res.data.record_id || queryObj.id,
                    classifyId: "",
                    form_id: "",
                    type: "view",
                  };
                  updateUrlParams(params);
                }
                isSubmit = false;
              },
              error: function (error) {
                isSubmit = false;
                return false;
              },
            });
          },
          errorPlacement: function (error, element) {
            $(error).addClass("error-fixed");
            $(element).parent().append(error);
          },
          errorElement: "span",
        });

        $("#loginForm1").submit();
      }

      // 见证记录表校验
      $("#loginForm2").validate({
        rule: loginForm2Map.rule,
        messages: loginForm2Map.messages,
        submitHandler: function () {
          if (isWnSubmit) {
            return;
          }
          isWnSubmit = true;
          var datas = $("#loginForm2").serializeArray();
          var submitData = {};
          $(datas).each(function (idx, item) {
            var already = submitData[item.name] || "";
            submitData[item.name] =
              (already ? already + "," : "") + $.trim(item.value) || "";
          });

          var params = {
            witness_data: submitData,
            target_day: queryObj.target_day,
            record_id: queryObj.id,
          };

          $.ajax({
            url: "http://meterial.cxhy.cn/updateWitness/",
            type: "POST",
            dataType: "json",
            contentType: "application/json",
            data: JSON.stringify(params),
            success: function (res) {
              if (res.code == 200) {
                toastr && toastr.success("见证记录更新成功");
                var params = {
                  id: queryObj.id,
                  classifyId: "",
                  form_id: "",
                  type: "view",
                };
                setTimeout(function () {
                  updateUrlParams(params);
                }, 1500);
              }
              isWnSubmit = false;
            },
            error: function (error) {
              isWnSubmit = false;
              return false;
            },
          });
        },
        errorPlacement: function (error, element) {
          $(error).addClass("error-fixed");
          $(element).parent().append(error);
        },
        errorElement: "span",
      });
      // 见证记录保存
      var isWnSubmit = false;
      witnessSave.click(function () {
        $("#loginForm2").submit();
      });
      // 触发编辑
      contractEdit.on("click", function () {
        updateUrlParams({
          type: "contractEdit",
        });
      });
      witnessEidt.on("click", function () {
        updateUrlParams({
          type: "witnessEdit",
        });
      });

      //非编辑才添加事件 点击生成见证记录
      $(".record").click(function () {
        var params = {
          record_id: queryObj.id, //  $("#loginForm1 .table-wp .table-order").html(),
          target_day: queryObj.target_day,
        };
        $.ajax({
          url: "http://meterial.cxhy.cn/generateWitness/",
          type: "POST",
          dataType: "json",
          contentType: "application/json",
          data: JSON.stringify(params),
          success: function (res) {
            if (res.code == 200) {
              var data = res.data;
              createWitnessId = res.data.id || "";
              //  有见证表，调整布局
              // if (data.witnessData && data.witnessData.tableData) {
              contractTable.removeClass("col-lg-12").addClass("col-lg-7");
              witnessTable
                .removeClass("col-lg-12 ")
                .addClass("col-lg-5")
                .removeClass("hidden");

              // mainWrapper.setAttribute("flex", "box:mean");
              [".record", ".resetBtn", ".save"].forEach(function (ele) {
                $(ele).addClass("hidden");
              });
              // }
              data.tableData.forEach(function (item) {
                if (nullTable != JSON.stringify(item)) {
                  dataToTable(item, "#loginForm2", loginForm2Map, data, true);
                }
              });
              // 二维码
              if (data.qrCode) {
                if (data.qrCode.contract) {
                  $(".contract-code").parent().removeClass("hidden");
                  $(".contract-code").attr("src", data.qrCode.contract);
                  $("#loginForm1 .print-code").removeClass("hidden");
                }
                if (data.qrCode.witness) {
                  $(".witness-code").attr("src", data.qrCode.witness);
                }
              }
            }
          },
          error: function (error) {},
        });
      });

      // 点击打印
      $(".print").click(function () {
        var fromId = $(this).attr("data-id");
        var htmlStr = $("#" + fromId)
          .find(".table-donwload-section")
          .clone(true);
        if(fromId == 'loginForm1') {
          $("#" + fromId)
          .find("tr, th")
          .attr("style", "height:28px");
        } else {
          $("#" + fromId)
          .find("tr, th")
          .attr("style", "height:45px");
        }
        
        
        replaceEl(fromId, "print");
        $("#" + fromId)
          .find(".table-donwload-section")
          .jqprint({
            debug: false, //如果是true则可以显示iframe查看效果，默认是false
            importCSS: true, //true表示引进原来的页面的css，默认是true。
            printContainer: true, //表示如果原来选择的对象必须被纳入打印，默认是true。
            operaSupport: true, ///表示如果插件也必须支持歌opera浏览器，默认是true。
          });
        var stepWp = $("#loginForm1 label").hasClass("step-wp");
        if (stepWp) {
          $("#loginForm1 .step-wp>div").eq(0).addClass("hidden");
          $("#loginForm1 .step-wp>div").eq(1).removeClass("hidden");
        }
        $("#" + fromId)
          .find(".table-donwload-section")
          .remove();
        $("#" + fromId).prepend(htmlStr);
      });

      // 第几步fn
      function setpFn(fromId, isPrint) {
        // 第xxx步替换
        var stepWp = $("#" + fromId)
          .find("label")
          .hasClass("step-wp");
        if (stepWp) {
          $("#loginForm1 label>.main input").each(function () {
            var tempVal = $(this).val() ? $(this).val() : "&nbsp;";
            $(this).replaceWith(
              '<span style="text-decoration:underline;">' + tempVal + "</span>"
            );
          });
        }
      }
      // 替换标签
      function replaceEl(fromId, isPrint) {
        setpFn(fromId, isPrint);
        changeImgToDataurl();
        // 替换表头上的功能
        var ths = $("#" + fromId).find(".table-header th");
        ths.each(function (idx, inputEle) {
          var spanText = $(inputEle).find("span").text();
          var iptVal = $(inputEle).find("input").val();
          $(inputEle).html(spanText + iptVal);
          $(inputEle).attr("style", "width: 300px");
        });
        // 处理输入框内容替换
        var entrys = $("#" + fromId).find("input[type='text']");
        var selects = $("#" + fromId).find('input[type="checkbox"]');
        var radios = $("#" + fromId).find('input[type="radio"]');
        var areas = $("#" + fromId).find("textarea");
        entrys = Array.prototype.slice.call(entrys);
        entrys.forEach(function (inputEle) {
          // inputEle.checked
          if (!$(inputEle).hasClass("ipt-self")) {
            var val = $(inputEle).val() || "";
            $(inputEle).parent().append("<span></span>");
            $(inputEle).siblings().text(val);
            $(inputEle).remove();
            // $(inputEle).parent().html(val);
            // $(inputEle).siblings(".placeholder").text(val);
          } else {
            var val = $(inputEle).val() || "";
            $(inputEle).parent().attr("style", "text-align:center");
            $(inputEle)
              .parent()
              .append("<span>" + val + "</span>");
            $(inputEle).remove();
          }
        });

        areas.each(function (idx, inputEle) {
          // inputEle.checked
          var val = $(inputEle).val() || "";
          $(inputEle).parent().attr("style", "text-align:center");
          $(inputEle).parent().html(val);
          // $(inputEle).siblings(".placeholder").text(val);
        });

        selects.each(function (idx, inputEle) {
          var checked = inputEle.checked;
          $(inputEle)
            .siblings(".placeholder")
            .text(checked ? "■" : "□");
        });
        radios.each(function (idx, inputEle) {
          var checked = inputEle.checked;
          $(inputEle)
            .siblings(".placeholder")
            .text(checked ? "■" : "□");
        });
      }

      // 点击“其他" 添加输入框
      setTimeout(() => {
        $("#loginForm1 .main span").each(function () {
          $(this).replaceWith(
            '<input value="' +
              $(this).html() +
              '" maxLength="2" class="class-step">'
          );
        });
        // 处理勾选其他的样式
        var selects = $("#loginForm1").find(".class-other");
        selects.each(function (idx, inputEle) {
          $(inputEle).change(function () {
            var checked = $(inputEle).is(":checked");
            var val =
              $(inputEle).attr("subVal") == "null"
                ? ""
                : $(inputEle).attr("subVal");
            var sid = $(inputEle).attr("subSid");
            if (checked) {
              $(inputEle)
                .parent()
                .append(
                  '<input type="text" value="' +
                    val +
                    '"  name="' +
                    sid +
                    '" class="ipt-self"/>'
                );
              // $(inputEle).parent()
            } else {
              if ($(inputEle).parent().find(".ipt-self")) {
                $(inputEle).parent().find(".ipt-self").remove();
              }
            }
          });
        });
      }, 1000);

      // 打印二维码
      $(".print-code").click(function () {
        var fromId = $(this).attr("data-id");
        $("#" + fromId)
          .find(".qr-code")
          .attr(
            "style",
            "position:absolute;top:50%;left:50%;margin-left:-150px;margin-top:-150px;"
          );
        $("#" + fromId)
          .find(".qr-code img")
          .attr(
            "style",
            "width:300px;height:300px;background-size:300px 300px;"
          );
        $("#" + fromId)
          .find(".qr-code img")
          .attr("width", "150pt");
        $("#" + fromId)
          .find(".qr-code img")
          .attr("height", "150pt");
        $("#" + fromId)
          .find(".qr-code")
          .jqprint();
        $("#" + fromId)
          .find(".qr-code")
          .attr(
            "style",
            "width: 155px;height: 155px; overflow:hidden;text-align: right"
          );
        $("#" + fromId)
          .find(".qr-code img")
          .attr(
            "style",
            "width:150px;height:150px;background-size:150px 150px;"
          );
      });
    </script>
  </body>
</html>
